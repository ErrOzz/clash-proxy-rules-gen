# Network Configuration & Rule Management System

Комплексная система для централизованного управления сетевой маршрутизацией и автоматизации администрирования сервера на базе 3x-ui (Xray).

Проект состоит из двух независимых, но взаимосвязанных модулей:
1.  **Rule Manager (GitHub Side):** Автоматическая генерация файлов правил маршрутизации на основе списка доменов.
2.  **Configuration Manager (Server Side):** Автоматическая генерация клиентских конфигураций, синхронизация с панелью управления и ротация параметров безопасности.

---

## 1. Модуль управления правилами (GitHub Side)

Этот модуль работает автономно внутри репозитория GitHub. Его задача — превращать простой текстовый список доменов в формат, понятный современным клиентам (Clash Meta/Mihomo), и поддерживать этот список в актуальном состоянии.

### Структура (Rule Manager)

```text
.
├── .github/
│   └── workflows/
│       ├── main.yml          # Авто-генерация правил при изменении списка
│       └── check_rules.yml   # Периодическая проверка доступности доменов
├── rules/
│   └── rules_proxy           # [ВАШ ФАЙЛ] Мастер-список доменов (один на строку)
├── scripts/
│   ├── deploy.sh             # Логика генерации YAML-правил
│   └── check_domains.sh      # Логика DNS-проверки доменов
└── clash_proxy_rules.yaml    # [АВТО] Итоговый файл правил (Rule Provider)
```

### Как использовать

1.  **Добавление ресурса:** Отредактируйте файл `rules/rules_proxy` в репозитории, добавив нужный домен.
2.  **Применение:** Сделайте `git push`. GitHub Actions автоматически запустят `deploy.sh` и обновят файл `clash_proxy_rules.yaml`.
3.  **Ссылка для клиентов:** Используйте ссылку на Raw-версию файла `clash_proxy_rules.yaml` в ваших конфигурациях (см. переменную `RULE_PROVIDER_URL` в серверном модуле).

### Автоматическое обслуживание
Раз в неделю запускается скрипт `check_domains.sh`, который проверяет наличие DNS-записей у доменов из списка. Недоступные домены помечаются комментарием `# not available`.

---

## 2. Модуль управления сервером (Server Side)

Этот модуль разворачивается на вашем VPS. Он связывает панель управления 3x-ui, внешний список правил и GitHub Gist для доставки готовых настроек конечным пользователям.

### Структура (Server Manager)

```text
/opt/clash-proxy-rules-gen/
├── config-generator/
│   ├── .env                  # [СЕКРЕТЫ] Настройки доступа, API ключи
│   ├── extra_servers.yaml    # [ОПЦИОНАЛЬНО] Резервные узлы
│   ├── rotation_domains.yaml # Список доменов для ротации SNI
│   ├── requirements.txt      # Зависимости Python
│   │
│   ├── sync_configs.py       # Генерация клиентских конфигов и выгрузка в Gist
│   ├── rotate_settings.py    # Скрипт смены ключей и доменов (ротация)
│   ├── panel_api.py          # Модуль работы с API 3x-ui
│   ├── domain_tls_checker.py # Модуль валидации TLS 1.3
│   │
│   └── templates/
│       └── clash_client_template.yaml.j2  # Шаблон конфига клиента
│
├── run_with_tz.sh            # Обертка для запуска по расписанию
└── aliases.sh                # Файл с алиасами для удобного управления
```

### Функционал скриптов

#### `sync_configs.py`
*   **Задача:** Создать актуальные файлы настроек для каждого пользователя панели.
*   **Как работает:**
    1.  Забирает список пользователей и настройки VLESS/Reality из панели.
    2.  Добавляет ссылку на правила из Модуля 1 (`RULE_PROVIDER_URL`).
    3.  Добавляет GeoIP правила для корректной работы локальных сервисов (РФ).
    4.  Генерирует персональные YAML-файлы и загружает их в приватный GitHub Gist.

#### `rotate_settings.py`
*   **Задача:** Повышение скрытности сервера за счет смены параметров маскировки.
*   **Как работает:**
    1.  Генерирует новые ключи X25519 (используя криптографическую библиотеку Python с адаптацией кодировки под стандарты Xray).
    2.  Выбирает случайный домен из `rotation_domains.yaml` и проверяет его доступность по TLS 1.3.
    3.  Обновляет настройки инбаунда (SNI, Dest, Keys).
    4.  Вызывает `sync_configs.py` для мгновенного обновления подписок клиентов.

---

## Развертывание на сервере (Инструкция)

### Шаг 1. Подготовка системы
Установите необходимые пакеты:
```bash
sudo apt update && sudo apt install git python3-venv -y
```

### Шаг 2. Установка
```bash
sudo mkdir -p /opt/clash-proxy-rules-gen
sudo chown -R $USER:$USER /opt/clash-proxy-rules-gen
git clone https://github.com/ВАШ_НИК/clash-proxy-rules-gen.git /opt/clash-proxy-rules-gen
```

### Шаг 3. Настройка Python
```bash
cd /opt/clash-proxy-rules-gen/config-generator
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

### Шаг 4. Конфигурация (Файлы, которых нет в Git)

1.  **Создайте `.env`** в папке `config-generator`:
    ```ini
    PANEL_URL="http://127.0.0.1:2053"
    PANEL_USERNAME="admin"
    PANEL_PASSWORD="password"
    INBOUND_ID=1
    # Имя контейнера нужно, если вы захотите использовать docker команды вручную, скрипты работают через API/Python
    DOCKER_CONTAINER_NAME="3x-ui"
    GIST_ID="ваш_gist_id"
    GITHUB_TOKEN="ghp_ваш_токен"
    GITHUB_USERNAME="ваш_ник"
    SERVER_HOST="ваш.ip.или.домен"
    # Ссылка на файл из Модуля 1 (Raw)
    RULE_PROVIDER_URL="https://raw.githubusercontent.com/ВАШ_НИК/ИМЯ_РЕПО/main/clash_proxy_rules.yaml"
    ```

2.  **Создайте `extra_servers.yaml`** (если нужен резервный канал):
    ```yaml
    - name: "Backup Node"
      type: vless
      server: ...
    ```

### Шаг 5. Настройка удобств и автоматизации

**Алиасы:**
Добавьте подключение алиасов в `.bashrc`:
```bash
echo 'source /opt/clash-proxy-rules-gen/aliases.sh' >> ~/.bashrc
source ~/.bashrc
```
Теперь доступны команды: `clash-sync` (обновить конфиги), `clash-rotate` (сменить ключи).

**Планировщик (Cron):**
Настройте запуск проверки времени каждый час. Скрипт сам решит, когда выполнять ротацию (настроено на 1-е число месяца).
```bash
crontab -e
```
Добавьте строку:
```cron
30 * * * * /opt/clash-proxy-rules-gen/run_with_tz.sh >> /opt/clash-proxy-rules-gen/logs/rotate.log 2>&1
```

## Использование системы

1.  **Добавили домен в список?** -> Сделайте `git push` (Модуль 1 обновит правила, клиенты подтянут их автоматически).
2.  **Добавили пользователя в панель?** -> Запустите `clash-sync` на сервере.
3.  **Ротация ключей:** Происходит автоматически 1-го числа каждого месяца.